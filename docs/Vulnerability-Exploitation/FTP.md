---
title: FTP
parent: Vulnerability Exploitation
nav_order: 8
---

# FTP

서버와 클라이언트 간에 파일을 전송하기 위한 프로토콜

- 20번 포트 : 데이터 전송
> 능동 모드에서는 포트 20번을 쓰지만 수동 모드에서는 임의의 포트 번호를 쓴다.
>> 능동 모드 : 서버가 데이터 전송을 위해 클라이언트의 포트에 연결을 시도<br>
이 때 서버의 송신 포트가 20번<br><br>
>> 수동 모드 : 서버가 데이터 전송을 위한 포트를 열고 클라이언트가 해당 포트에 연결을 시도
- 21번 포트 : 통신을 위한 제어연결

## FTP 취약점 공격 시 확인해야 할 사항

1. FTP에 접근 가능한 계정 정보가 있는지 or 익명 로그인이 가능한지
2. 어떤 파일을 업로드/다운로드 할 수 있는지
3. 업로드 한 파일은 어느 경로에 저장되는지
4. 어떤 네트워크 서비스가 업로드 된 파일을 접근하고 실행할 수 있는지

# ftp 취약점 공격

## 정보 수집

<br>

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp01_포트스캔.png' | relative_url }}" style="width:600px;">
  <figcaption>포트 스캔</figcaption>
</figure>
<br>
<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp02_http서비스확인.png' | relative_url }}" style="width:600px;">
  <figcaption>http 서비스확인</figcaption>
</figure>

포트 스캔을 한 결과 21번 포트에서 ftp 서비스가 돌아가고 있는 것과 8080번 포트에서 http가 서비스 중인 것을 확인했다.

그리고 그 ftp 서비스는 익명 로그인이 허용되어 있다는 것도 알았다.

그럼 이제 ftp 서비스에 접속해보자
<br>

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp03_ftp접속.png' | relative_url }}" style="width:600px;">
  <figcaption>ftp 접속</figcaption>
</figure>



저번 취약점 진단 단계에서 이 타겟 머신이 
8080에서 돌아가고 있는 웹 서버가 ftp의 /uploads에 접근을 할 수가 있다라는 것을 저번에 알아봤다.
<br>

[NFS 취약점 진단](/docs/Vulnerability-Assessment/NFS-취약점-진단)

<br>

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp05_index.png' | relative_url }}" style="width:600px;">
  <figcaption>index.php</figcaption>
</figure>

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp04_secret.png' | relative_url }}" style="width:600px;">
  <figcaption>secret.txt</figcaption>
</figure>

저번 취약점 진단을 통해 ftp로 파일 업로드를 할 수 있고 http로 파일 실행을 할 수 있다 라는 것을 알았다.

추가적인 정보를 위해 웹 사이트의 기술 스택을 분석해주는 툴인 wappalyer를 사용해보자.

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp06_wappalyzer.png' | relative_url }}" style="width:600px;">
  <figcaption>wappalyzer</figcaption>
</figure>

서버의 운영체제가 ubuntu, 웹 서버는 apache http server라는 것을 알아냈다.

이런 정보들을 통해 나는 이런 전략을 세울 수 있었다.

1. ftp를 통해 페이로드를 업로드하고 http로 그 페이로드를 실행한다.
2. 여기서 페이로드는 wappalyzer에서 확인해본 것과 같이 리눅스의 apache를 겨냥하는 php 파일 포맷으로 된 reverse shell로 한다.

## 취약점 공격
<br>

<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp07_phprevshell.png' | relative_url }}" style="width:500px;">
  <figcaption>php reverse shell payload</figcaption>
</figure>
<br>
<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp08_주소수정.png' | relative_url }}" style="width:500px;">
  <figcaption>payload 수정</figcaption>
</figure>

페이로드는 칼리 리눅스에 기본적으로 탑재되어 있는 페이로드를 사용했다.
<br><br>
<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp09_upload.png' | relative_url }}" style="width:600px;">
  <figcaption>reverse shell upload</figcaption>
</figure>
<br>
<figure style="text-align:center;">
  <img src="{{ '/assets/images/ftp/ftp10_revshell성공.png' | relative_url }}" style="width:600px;">
  <figcaption>reverse shell 성공</figcaption>
</figure>

웹 페이지에서 url에 php-reverse-shell.php을 입력했더니 열어둔 1234번 포트로 reverse shell이 연결되었다.

이제 권한 상승 및 후속 공격을 진행하면 된다.
