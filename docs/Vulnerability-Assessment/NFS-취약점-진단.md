---
title: NFS 취약점 진단
parent: Vulnerability Assessment
nav_order: 1
---

# NFS 취약점 진단

## NFS
네트워크 상에서 호스트의 파일 및 디렉토리를 공유하는 프로토콜/네트워크 서비스

### 포트
- 2049  : 일반적인 파일을 주고받을 때 사용되는 포트
- 111   : NFS를 포함한 RPC 기반 서비스가 사용하는 포트로, Portmapper 또는 RPCbind 서비스를 위한 포트

> Portmapper, RPCbind란?
> - RPC 기반 서비스가 동작할 때 클라이언트가 서버의 올바른 포트를 찾을 수 있도록 도와주는 서비스
> - RPCbind는 portmapper의 더 현대적인 버전으로 동일한 기능을 수행하지만 더 많은 보안 기능이 추가된 서비스

## NFS 취약점 진단을 할 때 살펴봐야 할 것

- 접근 제어 : NFS가 어떤 디렉토리들을 노출중이며, 어떤 호스트가 NFS에 접근 가능한가
- 파일 권한 : 어떤 파일이나 어떤 디렉토리들에 읽기/쓰기 권한이 있는지
- No_root_squash : 클라이언트들의 유저 권한을 무시하는 no_root_squash 설정이 비활성화 되어있는지



# 실습
## nmap 을 활용한 방법

```nmap -p 111,2049 --open -sV --script='nfs-*' <IP주소>```
{: .fs-6 .text-center}

포트 111번, 2049번에 대해 해당 포트가 열려있는지 확인하고 열려있다면 운용 중인 서비스 버전을 표시하고 nfs와 관련된 모든 NSE 스크립트를 실행하도록 명령어를 작성한다.

![nmap실행결과](\assets\images\nfs1_nmap실행결과.png)
nmap명령어 실행 결과 
{: .text-center}

여기서 NSE 스크립트로 얻을 수 있는 정보는 빨간색 표시 부분 nfs-statfs, nfs-showmount, nfs-ls 부분이다.

- nfs-statfs    : 파일 시스템 관련된 상세 정보(파일 시스템명, 총 용량, 사용한 용량 등)
- nfs-showmount : nfs 서버가 현재 노출을 하고 있는 디렉터리와 그 디렉터리에 접근할 수 있는 IP 대역
- nfs-ls        : nfs 공유 디렉터리 안에 있는 파일과 디렉터리 상세 정보

또한 rpcinfo 항목에선 해당 서버에서 동작 중인 RPC 기반 서비스와 포트 매핑 정보를 알 수 있다.


## showmount를 활용한 방법

![showmount실행결과](\assets\images\nfs2_showmount실행결과.png)
{: .text-center}
showmount실행결과
{: .text-center}
NSE 스크립트 중 showmount를 실행했을 때와 같은 결과가 나온 것을 확인할 수 있다.

## NFS 디렉토리에 마운트 하는 법

```sudo mount <IP주소>:<NFS서버가 노출하고 있는 디렉토리> <마운트할 경로>```
{: .fs-6 .text-center}

![nfs마운트1](\assets\images\nfs3_nfs마운트1.png)
{: .text-center}
NFS 마운트
{: .text-center}

/mnt 디렉터리 하위에 마운트할 임의의 디렉터리를 만들고 명령어를 실행하면 해당위치에 마운트 된다.

![nfs마운트2](\assets\images\nfs4_nfs마운트2.png)
{: .text-center}
NFS 마운트 결과1
{: .text-center}
![nfs마운트3](\assets\images\nfs5_nfs마운트3.png)
{: .text-center}
NFS 마운트 결과2
{: .text-center}

마운트한 디렉터리를 확인해보면 credentails.txt라는 민감한 파일을 획득할 수 있다.


## no_root_squash 설정 진단

> no_root_squash 설정이란
> NFS 서버가 클라이언트에서 접속한 사용자 중 root 사용자를 그대로 root로 동작하는 것을 허용하는 옵션이다.
> 악성 사용자가 클라이언트에서 root로 접속한 후 NFS 서버로 드렁와 악의적인 행동을 할 수 있기 때문에 해당 옵션을 비활성화 하는 것이 좋다.

![no_root_squash설정점검](\assets\images\nfs6_norootsquash.png)
{: .text-center}
no_root_squash 설정 점검
{: .text-center}
클라이언트 환경에서 root 권한으로 NFS 서버에 접속한 후 파일 작성을 한 결과이다.
attacker라는 파일이 잘 생성된 것을 볼 수 있다.
이처럼 공격자가 악의적인 파일을 생성할 수 있기 때문에 no_root_squash 옵션은 비활성화 해두는 것이 권장된다.

